#!/bin/bash

debootstrap_part1_Func() {
    export DEBIAN_"${install_warning_level}"
    
    cat > /etc/apt/apt.conf.d/30apt_error_on_transient <<-EOF
		APT::Update::Error-Mode "any";
	EOF
    
    identify_apt_data_sources
    apt_sources "base" "${ubuntu_original}"
    
    if [ -n "${mirror_archive}" ]; then
        apt_mirror_source
    fi
    
    cat "${apt_data_sources_loc}"
    
    trap 'printf "%s\n%s" "The script has experienced an error during the first apt update. That may have been caused by a queried server not responding in time. Try running the script again." "If the issue is the security server not responding, then comment out the security server in the \"${apt_data_sources_loc}\". Alternatively, you can uncomment the command that does this in the install script. This affects the temporary live iso only. Not the permanent installation."' ERR
    apt update
    trap - ERR

    keyboard_console_settings # Request keyboard and console settings.
    
    apt-get -yq install debootstrap software-properties-common gdisk zfs-initramfs
    if service --status-all | grep -Fq 'zfs-zed'; then
        systemctl stop zfs-zed
    fi

    if [ -z "${OS_INSTALL_MODE:-}" ]; then
        clear_partition_table "root"
        partprobe
        sleep 2
        partitionsFunc
    else
        echo "Skipping partition clearing and creation in existing install mode."
    fi
}

debootstrap_installminsys_Func() {
    ## Install minimum system
    FREE="$(df -k --output=avail "$mountpoint" | tail -n1)"
    if [ "$FREE" -lt 5242880 ]; then # 5 GB
         echo "Less than 5 GBs free!"
         exit 1
    fi
    
    debootstrap "$ubuntuver" "$mountpoint"
}

zfsbootmenu_install_config_Func() {
    zfsbootmenu_install_config_loc="/tmp/zfsbootmenu_install_config.sh"
    cat <<-EOH >"${zfsbootmenu_install_config_loc}"
		#!/bin/bash
		set -euo pipefail
		# set -x
		apt update

		compile_zbm_git() {
			apt-get install --yes bsdextrautils mbuffer
			apt-get install --yes --no-install-recommends \
				libsort-versions-perl libboolean-perl libyaml-pp-perl \
				git fzf make kexec-tools dracut-core cpio curl
			
			mkdir -p /usr/local/src/zfsbootmenu
			cd /usr/local/src/zfsbootmenu

			zbm_release="git" ## "git" for git master, "release" for latest release.
			case "\${zbm_release}" in
				git) git clone https://github.com/zbm-dev/zfsbootmenu . ;;
				release)
					latest_tar="\$(curl -s https://api.github.com/repos/zbm-dev/zfsbootmenu/releases/latest | grep tarball | cut -d : -f 2,3 | tr -d \" | sed 's/^[ \t]*//;s/,//')"
					curl -L "\${latest_tar}" | tar -zxv --strip-components=1 -f -
				;;
				*) exit 1 ;;
			esac
			make core dracut
		}
		compile_zbm_git

		config_zbm() {
			kb_layoutcode="\$(debconf-get-selections | grep keyboard-configuration/layoutcode | awk '{print \$4}')"
			sed \
			-e 's,ManageImages:.*,ManageImages: true,' \
			-e 's@ImageDir:.*@ImageDir: /boot/efi/EFI/ubuntu@' \
			-e 's,Versions:.*,Versions: false,' \
			-e "/CommandLine/s,ro,rd.vconsole.keymap=\${kb_layoutcode} ro," \
			-i /etc/zfsbootmenu/config.yaml

			if [ "$quiet_boot" = "no" ]; then
				sed -i 's,ro quiet,ro,' /etc/zfsbootmenu/config.yaml
			fi
			
		}
		config_zbm

		update-initramfs -c -k all
		generate-zbm --debug
	EOH

    case "$1" in
        chroot)
            cp "${zfsbootmenu_install_config_loc}" "$mountpoint/tmp"
            chroot "$mountpoint" /bin/bash -x "/tmp/$(basename "${zfsbootmenu_install_config_loc}")"
        ;;
        base) /bin/bash "${zfsbootmenu_install_config_loc}" ;;
        *) exit 1 ;;
    esac
}


systemsetupFunc_part1() {
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		export DEBIAN_"${install_warning_level}"
EOCHROOT
    cp /etc/apt/apt.conf.d/30apt_error_on_transient "$mountpoint/etc/apt/apt.conf.d/"
    echo "$hostname" > "$mountpoint/etc/hostname"
    echo "127.0.1.1       $hostname" >> "$mountpoint/etc/hosts"
    
    ethernetinterface="$(basename "$(find /sys/class/net -maxdepth 1 -mindepth 1 -name "${ethprefix}*")")"
    cat > "$mountpoint/etc/netplan/01-$ethernetinterface.yaml" <<-EOF
		network:
		  version: 2
		  ethernets:
		    $ethernetinterface:
		      dhcp4: yes
	EOF
    chmod 600 "$mountpoint/etc/netplan/01-$ethernetinterface.yaml"
    mount --rbind /dev "$mountpoint/dev"
    mount --rbind /proc "$mountpoint/proc"
    mount --rbind /sys "$mountpoint/sys"

    if [ -n "${mirror_archive}" ]; then
        apt_sources "chroot" "${ubuntu_mirror}"
    else
        apt_sources "chroot" "${ubuntu_original}"
    fi

    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		apt update
		locale-gen en_US.UTF-8 $locale
		echo 'LANG="$locale"' > /etc/default/locale
		ln -fs /usr/share/zoneinfo/"$timezone" /etc/localtime
		dpkg-reconfigure tzdata
EOCHROOT
}

systemsetupFunc_part2() {
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		apt update
		apt install --no-install-recommends -y linux-headers-generic linux-image-generic dkms wget nano software-properties-common
		apt install --yes zfsutils-linux zfs-zed zfs-initramfs
EOCHROOT
}

systemsetupFunc_part3() {
    identify_ubuntu_dataset_uuid
    apt install --yes dosfstools
    loop_counter=0
    while IFS= read -r diskidnum; do
        if [ "$loop_counter" -eq 0 ]; then
            esp_mount="/boot/efi"
        else
            esp_mount="/boot/efi$loop_counter"
            echo "$esp_mount" >> "$mountpoint/tmp/backup_esp_mounts.txt"
        fi
        if [ -z "${OS_INSTALL_MODE:-}" ]; then
             umount -q "/dev/disk/by-id/${diskidnum}-part1" || true
             mkdosfs -F 32 -s 1 -n EFI "/dev/disk/by-id/${diskidnum}-part1"
        else
             echo "Skipping EFI formatting in existing install mode."
        fi
        partprobe && sleep 2
        blkid_part1="$(blkid -s UUID -o value "/dev/disk/by-id/${diskidnum}-part1")"
        chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
			mkdir -p "${esp_mount}"
			echo "/dev/disk/by-uuid/$blkid_part1 ${esp_mount} vfat defaults 0 0" >> /etc/fstab
			mount "${esp_mount}"
EOCHROOT
        loop_counter=$((loop_counter + 1))
    done < /tmp/diskid_check_root.txt

    initial_boot_order="$(efibootmgr | grep "BootOrder" | cut -d " " -f 2)"
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		apt-get -yq install refind kexec-tools dpkg-dev git systemd-sysv
		sed -i 's,^timeout .*,timeout $timeout_rEFInd,' /boot/efi/EFI/refind/refind.conf
		echo REMAKE_INITRD=yes > /etc/dkms/zfs.conf
		sed -i 's,LOAD_KEXEC=false,LOAD_KEXEC=true,' /etc/default/kexec
EOCHROOT

    ## Format and Mount unmanaged ext4 partition
    while IFS= read -r diskidnum; do
        if [ -z "${OS_INSTALL_MODE:-}" ]; then
             mkfs.ext4 -F "/dev/disk/by-id/${diskidnum}-part3"
        else
             echo "Skipping ext4 data partition formatting in existing install mode."
        fi
        blkid_part3="$(blkid -s UUID -o value "/dev/disk/by-id/${diskidnum}-part3")"
        chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
			mkdir -p "${ext4_data_mount}"
			echo "UUID=$blkid_part3 ${ext4_data_mount} ext4 defaults 0 2" >> /etc/fstab
EOCHROOT
    done < /tmp/diskid_check_root.txt
}

systemsetupFunc_part4() {
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		echo "UMASK=0077" > /etc/initramfs-tools/conf.d/umask.conf
EOCHROOT


    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT					
		cmd="spl_hostid=\$( hostid ) ro"
		if [ "$quiet_boot" = "yes" ]; then cmd="\$cmd quiet"; fi
		zfs set org.zfsbootmenu:commandline="\$cmd" "$RPOOL/ROOT"
EOCHROOT

    zfsbootmenu_install_config_Func "chroot"

    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		cat <<-REFIND > /boot/efi/EFI/ubuntu/refind_linux.conf
			"Boot default"  "zbm.timeout=$timeout_zbm_no_remote_access ro quiet loglevel=0"
			"Boot to menu"  "zbm.show ro quiet loglevel=0"
		REFIND
		if [ "$quiet_boot" = "no" ]; then sed -i 's,ro quiet,ro,' /boot/efi/EFI/ubuntu/refind_linux.conf; fi
EOCHROOT
    
    case "$topology_root" in
        single) true ;;
        *) zbm_multiple_ESP ;;
    esac

}

zbm_multiple_ESP() {
    esp_sync_path="/etc/zfsbootmenu/generate-zbm.post.d/esp-sync.sh"
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		mkdir -p "/etc/zfsbootmenu/generate-zbm.post.d/"
		cat > "$esp_sync_path" <<-"EOT"
			#!/bin/sh
			sync_func() { rsync --delete-after -axHAWXS --info=progress2 /boot/efi/ "\$1"; }
		EOT
		while IFS= read -r esp_mount; do
			echo "sync_func \"\$esp_mount\"" >> "$esp_sync_path"
		done < /tmp/backup_esp_mounts.txt
		chmod +x "$esp_sync_path"
		apt install -y rsync
		sh "$esp_sync_path"
EOCHROOT
    
    # efibootmgr updates
    i=0
    while IFS= read -r diskidnum; do
        if [ "$i" -gt 0 ]; then
            device_name="$(readlink -f "/dev/disk/by-id/${diskidnum}")"
            efibootmgr --create --disk "${device_name}" --label "rEFInd Boot Manager Backup $i" --loader \\EFI\\refind\\refind_x64.efi
        fi
        i=$((i + 1))
    done < /tmp/diskid_check_root.txt
}

systemsetupFunc_part5() {
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		printf "root:$PASSWORD\n" | chpasswd
EOCHROOT
    
    # Swap setup removed for hybrid layout where part2 is ZFS Root
    
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		cp /usr/share/systemd/tmp.mount /etc/systemd/system/
		systemctl enable tmp.mount
		addgroup --system lpadmin
		addgroup --system lxd
		addgroup --system sambashare
		update-initramfs -c -k all
EOCHROOT
}



fixfsmountorder() {
    identify_ubuntu_dataset_uuid
    chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		mkdir -p /etc/zfs/zfs-list.cache
		touch /etc/zfs/zfs-list.cache/$RPOOL
		zed -F &
		count=0
		while [ ! -s /etc/zfs/zfs-list.cache/$RPOOL ] && [ \$count -lt 60 ]; do
			zfs set canmount=noauto "$RPOOL/ROOT/${rootzfs_full_name}"
			sleep 1
			count=\$((count + 1))
		done
		pkill -9 zed || true
		sed -Ei "s|$mountpoint/?|/|" /etc/zfs/zfs-list.cache/$RPOOL
EOCHROOT
}

keyboard_console_setup() {
    cp /tmp/kb_console_selections.conf "$mountpoint/tmp"
    chroot "$mountpoint" <<-EOCHROOT
		apt install -y debconf-utils
		debconf-set-selections < /tmp/kb_console_selections.conf
		rm -f /etc/default/keyboard
		dpkg-reconfigure -f noninteractive keyboard-configuration
		dpkg-reconfigure -f noninteractive console-setup
EOCHROOT
}

unmount_datasets() {
    mount --make-rslave "$mountpoint/dev"
    mount --make-rslave "$mountpoint/proc"
    mount --make-rslave "$mountpoint/sys"
    grep "$mountpoint" /proc/mounts | cut -f2 -d" " | sort -r | xargs umount -n || true
}

usersetup() {
	## Create user account and setup groups
	chroot "$mountpoint" /bin/bash -x <<-EOCHROOT
		## gecos parameter disabled asking for finger info
		adduser --disabled-password --gecos "" "$user"
		cp -a /etc/skel/. "/home/$user"
		chown -R "$user":"$user" "/home/$user"
		usermod -a -G adm,cdrom,dip,lpadmin,lxd,plugdev,sambashare,sudo "$user"
		printf "$user:$PASSWORD\n" | chpasswd

		## Disable root login with password.
		passwd -dl root
	EOCHROOT
}

reinstall-zbm() {
    disclaimer
    connectivity_check

    if grep -q casper /proc/cmdline; then
        echo "Live environment present. Reboot into new installation to re-install ZFSBootMenu."
        exit 1
    fi

    command -v generate-zbm >/dev/null 2>&1 || { echo "generate-zbm not found. Exiting."; exit 1; }

    # Version check
    latest_v="$(curl -s https://api.github.com/repos/zbm-dev/zfsbootmenu/releases/latest | grep tag_name | cut -d : -f 2,3 | tr -d \" | sed 's/^[ \t]*//;s/,//;s/^v//')"
    installed_v="$(generate-zbm --showver 2>/dev/null || echo "Unknown")"
    
    echo "Latest ZFSBootMenu version: $latest_v"
    echo "Installed ZFSBootMenu version: $installed_v"

    if [ "$latest_v" = "$installed_v" ]; then
        user_action_banner "Latest ZBM version is already installed.\n  Re-install anyway? (y/N)"
        read -r -p "Select option: " choice
        case "$choice" in
            [Yy]*) zfsbootmenu_install_config_Func "base" ;;
            *) echo "Exiting."; exit 0 ;;
        esac
    else
        zfsbootmenu_install_config_Func "base"
    fi
}
